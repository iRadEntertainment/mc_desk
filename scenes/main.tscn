[gd_scene load_steps=21 format=2]

[ext_resource path="res://scripts/main.gd" type="Script" id=1]
[ext_resource path="res://styles/tool_buttons.tres" type="Theme" id=2]
[ext_resource path="res://sprites/leds.png" type="Texture" id=3]
[ext_resource path="res://styles/regular_buttons1.tres" type="Theme" id=4]
[ext_resource path="res://scripts/login_panel.gd" type="Script" id=5]
[ext_resource path="res://styles/small_labels.tres" type="Theme" id=6]

[sub_resource type="StyleBoxEmpty" id=1]

[sub_resource type="GDScript" id=2]
script/source = "extends Button


func _ready():
	netwrk.connect(\"network_status_changed\",self,\"_network_status\")
	netwrk.reconnect_timer.connect(\"timeout\",self,\"_reconnection_attempt\")
	
	connect(\"resized\",self,\"_adjust_sprite_pos_on_resize\")
	$led.frame = 0
	hint_tooltip = \"Connecting...\"

func _network_status(val):
	if val:
		$led/anim.play(\"connection_succeed\")
		hint_tooltip = \"Server ON\"
		set_process(false)
	else:
		$led/anim.stop()
		$led.set(\"frame\",2)
		hint_tooltip = \"Server OFF\"

func _pressed():
	if netwrk.connecting or netwrk.established:
		netwrk.disconnect_from_server()
	else:
		netwrk.connect_to_server()

func _reconnection_attempt():
	$led/anim.stop()
	$led/anim.play(\"connection_attempt\")
	set_process(true) #for an update on the hint box on how many seconds left for the next attempt

var tim = 0
func _process(d):
	if netwrk.reconnect_timer.is_stopped():
		set_process(false)
	
	tim += d
	if tim > 0.3:
		tim -= 0.3
		update_hint_box()
	

func update_hint_box():
	if $led/anim.is_playing():
		hint_tooltip = \"Connecting...\"
	else:
		hint_tooltip = \"Retrying connection in %3d seconds...\\nAttempt num. %d\"\\
		               %[netwrk.reconnect_timer.time_left , netwrk.connection_attempt]


func _adjust_sprite_pos_on_resize():
	$led.position = rect_size/2"

[sub_resource type="Animation" id=3]
resource_name = "connection_attempt"
tracks/0/type = "value"
tracks/0/path = NodePath(".:frame")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.1, 0.3, 0.4, 0.6, 0.7, 0.9, 1 ),
"transitions": PoolRealArray( 1, 1, 1, 1, 1, 1, 1, 1 ),
"update": 1,
"values": [ 2, 0, 2, 0, 2, 0, 2, 0 ]
}

[sub_resource type="Animation" id=4]
resource_name = "connection_succeed"
length = 0.8
tracks/0/type = "value"
tracks/0/path = NodePath(".:frame")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8 ),
"transitions": PoolRealArray( 1, 1, 1, 1, 1, 1, 1, 1, 1 ),
"update": 1,
"values": [ 1, 0, 1, 0, 1, 0, 1, 0, 1 ]
}

[sub_resource type="GDScript" id=5]
script/source = "extends Button

func _pressed():
	glb.main.show_panel(\"control panel\")"

[sub_resource type="GDScript" id=6]
script/source = "extends Button

func _pressed():
	glb.main.show_panel(\"login panel\")"

[sub_resource type="GDScript" id=7]
script/source = "extends Button

func _pressed():
	netwrk.connect_to_server()"

[sub_resource type="GDScript" id=8]
script/source = "extends Button

func _pressed():
	netwrk.disconnect_from_server()"

[sub_resource type="GDScript" id=9]
script/source = "extends Button

func _pressed():
	if netwrk.established:
		remote_func.rpc_id(1,\"shut_down_server\")"

[sub_resource type="GDScript" id=10]
script/source = "extends Button

func _pressed():
	if netwrk.established:
		remote_func.rpc_id(1,\"restart_server\")"

[sub_resource type="GDScript" id=11]
script/source = "extends Button

func _pressed():
	if netwrk.established:
		remote_func.rpc_id(1,\"send_server_log\",get_tree().get_network_unique_id())"

[sub_resource type="GDScript" id=12]
script/source = "extends Button

func _pressed():
	if netwrk.established:
		var val = remote_func.rpc_id(1,\"test\")
		yield(get_tree(),\"idle_frame\")
		print(val)"

[sub_resource type="GDScript" id=13]
script/source = "extends Button

var max_iterations = 9000000
var tmr = Timer.new()
var fl_running = false

var step = 0
var val = 0



func _ready():
	$PI_val.text = str( \"%.16f\"%PI )
	add_child(tmr)
	set_process(false)
	set_physics_process(false)
#	tmr.one_shot = false
#	tmr.wait_time = 0.001
#	tmr.connect(\"timeout\",self,\"_count_step\")

func _pressed():
	_count_step()
	val = 0
	
#	if fl_running:
##		tmr.stop()
#		set_process(false)
#		set_physics_process(false)
#		fl_running = false
#		step = 0
#	else:
##		tmr.start()
##		set_process(true)
#		set_physics_process(true)
#		val = 0
#		fl_running = true

#func _physics_process(delta):
#	_count_step()

#func _process(delta):
#	_count_step()

#var adding_frac = 1.0
#func _count_step():
#	if step > max_iterations:
##		tmr.stop()
#		set_process(false)
#		set_physics_process(false)
#		fl_running = false
#		print(\"step: \",step, \" - val: \", str(val*4))
#		$calc_val.text = str(val*4)
#		step = 0
#	else:
#		adding_frac = 1.0/(1+2*step) # * (-1 + 2*int(step%2 == 0) )
#		if step%2 != 0:
#			adding_frac *= -1
#		val += adding_frac
#
##		if step%15 == 0:
##			print(\"step: \",step, \" - val: \", str(val*4))
##			$calc_val.text = str(val*4)
#
#		step += 1


func _count_step():
	var adding_frac = 1.0
	var tick_start = OS.get_ticks_msec()
	var tick_last  = tick_start
	while step < max_iterations:
		adding_frac = 1.0/(1+2*step) # * (-1 + 2*int(step%2 == 0) )
		if step%2 != 0:
			adding_frac *= -1
		val += adding_frac
		if step%50000 == 0:
			var tick_elapsed = OS.get_ticks_msec()
			var tick_d = tick_elapsed - tick_last
			tick_last = tick_elapsed
			print(\"tick: \",str(tick_d),\" - step: \",step, \" - val: \", str(\"%.16f\"%(val*4) ))
		step += 1
	
	var tick_elapsed = OS.get_ticks_msec()
	var tick_d = tick_elapsed - tick_start
	
	print(\"step: \",step, \" - val: \", str(\"%.16f\"%(val*4) ) )
	$calc_val.text = str( \"%.16f\"%(val*4) , \" in \" , str(tick_d) , \" msec.\" )
	step = 0"

[sub_resource type="GDScript" id=14]
script/source = "extends VBoxContainer



var small_fonts_theme = load(\"res://styles/small_labels.tres\")



func _ready():
	remote_func.connect(\"server_log_received\",self,\"_update_all_entries\")
	remote_func.connect(\"server_log_updated\",self,\"_update_with_last_entry\")
	retrieve_server_log()


func retrieve_server_log():
	if netwrk.established:
		remote_func.rpc_id(1,\"send_server_log\",get_tree().get_network_unique_id())
		#rpc(\"send_server_log\") emit signal \"server_log_received\"

func _update_all_entries(server_log):
	#clear all childs
	for child in get_children():
		child.free()
	#add each entry
	#--load font theme
	for entry in server_log:
		add_entry(entry)
	
	yield(get_tree(),\"idle_frame\")
	yield(get_tree(),\"idle_frame\")
	yield(get_tree(),\"idle_frame\")
	$\"..\".scroll_vertical = 70000


func _update_with_last_entry(entry):
	add_entry(entry)
	yield(get_tree(),\"idle_frame\")
	yield(get_tree(),\"idle_frame\")
	yield(get_tree(),\"idle_frame\")
	$\"..\".scroll_vertical = 70000


func add_entry(entry):
	var new_label = Label.new()
	var dic = OS.get_datetime_from_unix_time(entry[0])
	var time = \"%s/%s %02d:%02d:%02d\"%[dic[\"month\"],dic[\"day\"],dic[\"hour\"],dic[\"minute\"],dic[\"second\"]]
	
	var user = \"Unknown\"
	match entry[1]:
		1:
			user = \"Server\"
			new_label.set(\"custom_colors/font_color\",Color.purple)
		0:
			user = \"To All\"
	var msg  = entry[2]
	
	new_label.text = \"%s %s - %s\"%[time,user,msg]
	new_label.theme = small_fonts_theme
	add_child(new_label)


"

[node name="main" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
script = ExtResource( 1 )

[node name="bg" type="ColorRect" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
color = Color( 0.992157, 0.972549, 0.752941, 1 )

[node name="top_bar" type="Control" parent="."]
editor/display_folded = true
anchor_right = 1.0
rect_min_size = Vector2( 0, 48 )

[node name="bg" type="ColorRect" parent="top_bar"]
anchor_right = 1.0
anchor_bottom = 1.0

[node name="hbox" type="HBoxContainer" parent="top_bar"]
editor/display_folded = true
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = 4.0
margin_top = 4.0
margin_right = -4.0
margin_bottom = -4.0

[node name="empty_space" type="VSeparator" parent="top_bar/hbox"]
visible = false
margin_right = 32.0
margin_bottom = 40.0
rect_min_size = Vector2( 32, 0 )
custom_styles/separator = SubResource( 1 )

[node name="server_conn" type="Button" parent="top_bar/hbox"]
margin_right = 40.0
margin_bottom = 40.0
rect_min_size = Vector2( 40, 40 )
focus_mode = 0
theme = ExtResource( 2 )
enabled_focus_mode = 0
script = SubResource( 2 )

[node name="led" type="Sprite" parent="top_bar/hbox/server_conn"]
position = Vector2( 20, 20 )
texture = ExtResource( 3 )
hframes = 3
frame = 1

[node name="anim" type="AnimationPlayer" parent="top_bar/hbox/server_conn/led"]
anims/connection_attempt = SubResource( 3 )
anims/connection_succeed = SubResource( 4 )

[node name="sep1" type="VSeparator" parent="top_bar/hbox"]
margin_left = 44.0
margin_right = 60.0
margin_bottom = 40.0
rect_min_size = Vector2( 16, 0 )

[node name="ctrl_panel" type="Button" parent="top_bar/hbox"]
margin_left = 64.0
margin_right = 179.0
margin_bottom = 40.0
focus_mode = 0
theme = ExtResource( 4 )
enabled_focus_mode = 0
text = "Control Panel"
script = SubResource( 5 )

[node name="log_panel" type="Button" parent="top_bar/hbox"]
margin_left = 183.0
margin_right = 283.0
margin_bottom = 40.0
focus_mode = 0
theme = ExtResource( 4 )
enabled_focus_mode = 0
text = "Login panel"
script = SubResource( 6 )

[node name="cnt_center" type="Control" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
margin_top = 48.0

[node name="control_room" type="Control" parent="cnt_center"]
editor/display_folded = true
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = 8.0
margin_top = 8.0
margin_right = -8.0
margin_bottom = -8.0

[node name="bg" type="ColorRect" parent="cnt_center/control_room"]
anchor_right = 1.0
anchor_bottom = 1.0
color = Color( 0.2, 0.196078, 0.196078, 1 )

[node name="hbox" type="HBoxContainer" parent="cnt_center/control_room"]
anchor_right = 1.0
anchor_bottom = 1.0
custom_constants/separation = 8

[node name="vbox" type="VBoxContainer" parent="cnt_center/control_room/hbox"]
margin_right = 116.0
margin_bottom = 536.0

[node name="connect" type="Button" parent="cnt_center/control_room/hbox/vbox"]
visible = false
margin_right = 116.0
margin_bottom = 37.0
rect_min_size = Vector2( 0, 32 )
focus_mode = 0
theme = ExtResource( 4 )
enabled_focus_mode = 0
text = "Connect"
script = SubResource( 7 )

[node name="disconnect" type="Button" parent="cnt_center/control_room/hbox/vbox"]
visible = false
margin_right = 116.0
margin_bottom = 37.0
rect_min_size = Vector2( 0, 32 )
focus_mode = 0
theme = ExtResource( 4 )
enabled_focus_mode = 0
text = "Disconnect"
script = SubResource( 8 )

[node name="shut_server" type="Button" parent="cnt_center/control_room/hbox/vbox"]
margin_right = 116.0
margin_bottom = 37.0
rect_min_size = Vector2( 0, 32 )
focus_mode = 0
theme = ExtResource( 4 )
enabled_focus_mode = 0
text = "Shut Server"
script = SubResource( 9 )

[node name="restart" type="Button" parent="cnt_center/control_room/hbox/vbox"]
margin_top = 41.0
margin_right = 116.0
margin_bottom = 78.0
rect_min_size = Vector2( 0, 32 )
focus_mode = 0
theme = ExtResource( 4 )
enabled_focus_mode = 0
text = "Restart server"
script = SubResource( 10 )

[node name="req_log" type="Button" parent="cnt_center/control_room/hbox/vbox"]
margin_top = 82.0
margin_right = 116.0
margin_bottom = 119.0
rect_min_size = Vector2( 0, 32 )
focus_mode = 0
theme = ExtResource( 4 )
enabled_focus_mode = 0
text = "Request log"
script = SubResource( 11 )

[node name="test" type="Button" parent="cnt_center/control_room/hbox/vbox"]
margin_top = 123.0
margin_right = 116.0
margin_bottom = 160.0
rect_min_size = Vector2( 0, 32 )
focus_mode = 0
theme = ExtResource( 4 )
enabled_focus_mode = 0
text = "test"
script = SubResource( 12 )

[node name="calc_PI" type="Button" parent="cnt_center/control_room/hbox/vbox"]
editor/display_folded = true
visible = false
margin_top = 123.0
margin_right = 116.0
margin_bottom = 160.0
rect_min_size = Vector2( 0, 32 )
focus_mode = 0
theme = ExtResource( 4 )
disabled = true
enabled_focus_mode = 0
text = "calculate PI"
script = SubResource( 13 )

[node name="PI_val" type="Label" parent="cnt_center/control_room/hbox/vbox/calc_PI"]
anchor_left = 1.0
anchor_right = 1.0
margin_left = 4.13342
margin_top = 0.486664
margin_right = 93.1334
margin_bottom = 14.4867
text = "PI val"

[node name="calc_val" type="Label" parent="cnt_center/control_room/hbox/vbox/calc_PI"]
anchor_left = 1.0
anchor_right = 1.0
margin_left = 4.64679
margin_top = 16.9136
margin_right = 93.6468
margin_bottom = 30.9136

[node name="scrl_log" type="ScrollContainer" parent="cnt_center/control_room/hbox"]
margin_left = 124.0
margin_right = 1008.0
margin_bottom = 536.0
size_flags_horizontal = 3

[node name="log_list" type="VBoxContainer" parent="cnt_center/control_room/hbox/scrl_log"]
margin_right = 884.0
margin_bottom = 536.0
size_flags_horizontal = 3
size_flags_vertical = 3
script = SubResource( 14 )

[node name="login_panel" type="Control" parent="cnt_center"]
anchor_right = 1.0
anchor_bottom = 1.0
script = ExtResource( 5 )

[node name="login_icons" type="GridContainer" parent="cnt_center/login_panel"]
editor/display_folded = true
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -150.0
margin_top = -223.15
margin_right = 150.0
margin_bottom = 76.8503
columns = 4

[node name="log_01" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_right = 72.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_02" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 76.0
margin_right = 148.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_03" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 152.0
margin_right = 224.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_04" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 228.0
margin_right = 300.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_05" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_top = 76.0
margin_right = 72.0
margin_bottom = 148.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_06" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 76.0
margin_top = 76.0
margin_right = 148.0
margin_bottom = 148.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_07" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 152.0
margin_top = 76.0
margin_right = 224.0
margin_bottom = 148.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_08" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 228.0
margin_top = 76.0
margin_right = 300.0
margin_bottom = 148.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_09" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_top = 152.0
margin_right = 72.0
margin_bottom = 224.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_10" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 76.0
margin_top = 152.0
margin_right = 148.0
margin_bottom = 224.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_11" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 152.0
margin_top = 152.0
margin_right = 224.0
margin_bottom = 224.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_12" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 228.0
margin_top = 152.0
margin_right = 300.0
margin_bottom = 224.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_13" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_top = 228.0
margin_right = 72.0
margin_bottom = 300.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_14" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 76.0
margin_top = 228.0
margin_right = 148.0
margin_bottom = 300.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_15" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 152.0
margin_top = 228.0
margin_right = 224.0
margin_bottom = 300.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_16" type="Button" parent="cnt_center/login_panel/login_icons"]
margin_left = 228.0
margin_top = 228.0
margin_right = 300.0
margin_bottom = 300.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="login_outputs" type="GridContainer" parent="cnt_center/login_panel"]
editor/display_folded = true
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -226.0
margin_top = 140.699
margin_right = 226.0
margin_bottom = 212.699
columns = 6

[node name="log_01" type="Button" parent="cnt_center/login_panel/login_outputs"]
margin_right = 72.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_02" type="Button" parent="cnt_center/login_panel/login_outputs"]
margin_left = 76.0
margin_right = 148.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_03" type="Button" parent="cnt_center/login_panel/login_outputs"]
margin_left = 152.0
margin_right = 224.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_04" type="Button" parent="cnt_center/login_panel/login_outputs"]
margin_left = 228.0
margin_right = 300.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_05" type="Button" parent="cnt_center/login_panel/login_outputs"]
margin_left = 304.0
margin_right = 376.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="log_06" type="Button" parent="cnt_center/login_panel/login_outputs"]
margin_left = 380.0
margin_right = 452.0
margin_bottom = 72.0
rect_min_size = Vector2( 72, 72 )
theme = ExtResource( 2 )

[node name="col_test" type="ColorRect" parent="cnt_center/login_panel"]
editor/display_folded = true
visible = false
margin_left = 764.657
margin_top = 422.319
margin_right = 804.657
margin_bottom = 462.319

[node name="hexadec" type="Label" parent="cnt_center/login_panel/col_test"]
margin_left = -4.75507
margin_top = 44.0975
margin_right = 45.2449
margin_bottom = 62.0975
theme = ExtResource( 6 )
text = "#00ff00"
